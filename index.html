<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>MEGA 公共文件夹图片浏览器 · 触控/手柄拖拽 + 捏合缩放</title>
  <style>
    :root{ --bg:#0b0d10; --fg:#e9eef5; --muted:#9aa4b2; --accent:#5dd6ff; --card:#10141a; --border:#1f2833; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%;}
    header{display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f1318,#0c0f13);}    
    header h1{font-size:1rem;margin:0;color:var(--fg);opacity:.9}
    header .spacer{flex:1}
    input[type=text]{width:36ch;max-width:64vw;background:var(--card);border:1px solid var(--border);color:var(--fg);padding:.5rem .6rem;border-radius:.6rem}
    button{background:var(--card);border:1px solid var(--border);color:var(--fg);padding:.5rem .7rem;border-radius:.6rem;cursor:pointer;font-size:.95rem}
    button:hover{border-color:#2f3a46}
    .content{display:grid;grid-template-columns:280px 1fr; min-height:0}
    .sidebar{border-right:1px solid var(--border);min-width:220px;max-width:420px;display:flex;flex-direction:column;min-height:0}
    .sidebar .bar{display:flex;gap:.5rem;padding:.5rem;border-bottom:1px solid var(--border);justify-content:space-between}
    .thumbs{overflow:auto;padding:.6rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.6rem}
    .thumb{position:relative;background:#0c1116;border:1px solid var(--border);border-radius:.5rem;aspect-ratio:1/1;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .name{position:absolute;left:.35rem;right:.35rem;bottom:.35rem;font-size:.7rem;color:var(--muted);text-shadow:0 1px 2px #000a;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .thumb.active{outline:2px solid var(--accent)}
    .viewer{position:relative;min-height:0}
    .stage{position:absolute;inset:0;background:#0a0c10;display:grid;place-items:center;overflow:hidden;touch-action:none}
    .img{max-width:none;max-height:none;user-select:none;-webkit-user-drag:none;transform-origin:0 0;will-change:transform}
    .overlay{position:absolute;left:0;right:0;bottom:0;display:flex;gap:.4rem;padding:.5rem;justify-content:center;pointer-events:none}
    .overlay .pill{pointer-events:auto;background:#0e1319bb;border:1px solid var(--border);backdrop-filter:blur(6px);padding:.35rem .55rem;border-radius:999px;display:flex;gap:.3rem;align-items:center}
    .overlay button{background:transparent;border:0;color:var(--fg);padding:.3rem .6rem;border-radius:.5rem}
    .overlay button:hover{background:#ffffff12}
    .hint{position:absolute;right:.6rem;top:.6rem;color:var(--muted);font-size:.8rem;background:#0e1319bb;border:1px solid var(--border);padding:.35rem .5rem;border-radius:.5rem}
    .empty{place-self:center;color:var(--muted);text-align:center;line-height:1.6}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>MEGA 公共文件夹图片浏览器</h1>
      <div class="spacer"></div>
      <input id="url" type="text" placeholder="粘贴 MEGA 文件夹分享链接（含 # 密钥）" />
      <button id="load">加载</button>
    </header>

    <div class="content">
      <aside class="sidebar">
        <div class="bar">
          <small style="color:var(--muted)">缩略图</small>
          <small id="count" style="color:var(--muted)">0</small>
        </div>
        <div id="thumbs" class="thumbs" aria-label="thumbnails"></div>
      </aside>

      <main class="viewer">
        <div class="stage" id="stage">
          <div class="empty" id="empty">粘贴 MEGA 文件夹链接点击“加载”。<br>支持拖拽/手势拖动、滚轮/捏合缩放、双击切换缩放。<br>（首次打开会从 MEGA 下载并在本地解密，较大的图片需要一点时间。）</div>
          <img id="img" class="img" alt="" />
          <div class="overlay">
            <div class="pill">
              <button id="fit">适应</button>
              <button id="one">100%</button>
              <button id="rotate">旋转90°</button>
              <button id="prev">上一张 ←</button>
              <button id="next">下一张 →</button>
            </div>
          </div>
          <div class="hint">拖拽=平移 · 捏合/滚轮=缩放 · 双击=切换缩放 · 方向键翻图</div>
        </div>
      </main>
    </div>
  </div>

  <!-- 直接使用 MEGAJS 浏览器版（ESM） -->
  <script type="module">
    import { File } from 'https://unpkg.com/megajs/dist/main.browser-es.mjs'; // 文档：https://mega.js.org/

    const urlInput = document.getElementById('url');
    const btnLoad = document.getElementById('load');
    const thumbs = document.getElementById('thumbs');
    const countEl = document.getElementById('count');
    const img = document.getElementById('img');
    const stage = document.getElementById('stage');
    const empty = document.getElementById('empty');
    const btnFit = document.getElementById('fit');
    const btnOne = document.getElementById('one');
    const btnRotate = document.getElementById('rotate');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');

    // 预填你的示例链接（可改为默认空）
    const DEFAULT_LINK = 'https://mega.nz/folder/k8B0VaaY#W1SkWbFvH7ITNnS35stUcA';
    urlInput.value = DEFAULT_LINK;

    // 文件列表（仅保存元数据与已下载的 Blob URL）
    /** @type {{name:string, fileObj:any, blobUrl?:string}[]} */
    let items = [];
    let index = -1;

    // 允许的图片扩展名
    const IMG_EXT = ['jpg','jpeg','png','gif','webp','bmp','avif','heic','heif','svg'];
    function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
    function isImage(name){ return IMG_EXT.includes(extOf(name)); }
    function mimeOf(name){
      const e = extOf(name);
      if(e==='jpg'||e==='jpeg') return 'image/jpeg';
      if(e==='png') return 'image/png';
      if(e==='gif') return 'image/gif';
      if(e==='webp') return 'image/webp';
      if(e==='bmp') return 'image/bmp';
      if(e==='avif') return 'image/avif';
      if(e==='svg') return 'image/svg+xml';
      if(e==='heic'||e==='heif') return 'image/heic';
      return 'application/octet-stream';
    }

    async function loadFolder(link){
      thumbs.innerHTML=''; countEl.textContent='…'; items=[]; index=-1; img.removeAttribute('src'); empty.style.display='';
      try{
        const folder = File.fromURL(link.trim());
        // 加载文件夹属性，获取 children 列表
        await folder.loadAttributes(); // 参考文档：Shared folders can be loaded using File.fromURL + loadAttributes()
        // 递归拍平所有子文件（忽略子目录，也可展开）
        /** @param {any} node */
        const walk = (node)=>{
          if(node.children && node.children.length){ node.children.forEach(walk); }
          else if(node.name && isImage(node.name)) collected.push(node);
        };
        const collected = [];
        if(folder.children) folder.children.forEach(walk);
        // 排序
        collected.sort((a,b)=>a.name.localeCompare(b.name, 'zh-Hans-CN'));
        items = collected.map(f=>({name:f.name, fileObj:f}));
        renderThumbs();
        if(items.length){ setImage(0); }
        countEl.textContent=String(items.length);
        if(!items.length){ empty.innerHTML='此文件夹中未发现图片文件。'; }
      }catch(err){
        console.error(err);
        alert('加载 MEGA 文件夹失败：'+ (err && err.message || err));
        countEl.textContent='0';
      }
    }

    function renderThumbs(){
      thumbs.innerHTML='';
      items.forEach((it,i)=>{
        const div=document.createElement('button');
        div.className='thumb';
        div.title=it.name;
        div.addEventListener('click',()=>setImage(i));
        const im=document.createElement('img');
        im.alt=it.name; im.loading='lazy'; im.decoding='async';
        // 缩略图懒加载：先显示占位，选中或进入视口时才真正下载
        const obs = new IntersectionObserver(async entries=>{
          entries.forEach(async en=>{
            if(en.isIntersecting){
              obs.disconnect();
              await ensureBlob(it);
              if(it.blobUrl) im.src = it.blobUrl; // 用原图充当缩略
            }
          });
        }, {root: thumbs});
        obs.observe(div);
        const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
        div.appendChild(im); div.appendChild(nm); thumbs.appendChild(div);
      });
    }

    async function ensureBlob(it){
      if(it.blobUrl) return;
      const data = await it.fileObj.downloadBuffer(); // Uint8Array/Buffer
      const blob = new Blob([data], {type: mimeOf(it.name)});
      it.blobUrl = URL.createObjectURL(blob);
    }

    // 视图控制
    let tx=0, ty=0, scale=1, rotation=0, naturalW=0, naturalH=0;
    function applyTransform(){ img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale}) rotate(${rotation}deg)`; }
    function fitToStage(){
      const rect = stage.getBoundingClientRect();
      if(!naturalW||!naturalH){ return; }
      const s = Math.min((rect.width*0.98)/naturalW, (rect.height*0.98)/naturalH);
      scale = Math.max(0.05, Math.min(8, s));
      tx = (rect.width - naturalW*scale)/2;
      ty = (rect.height - naturalH*scale)/2;
      applyTransform();
    }
    function setScaleAt(newScale,cx,cy){
      newScale = Math.max(0.05, Math.min(16, newScale));
      const beforeX = (cx - tx)/scale; const beforeY=(cy - ty)/scale;
      scale = newScale; tx = cx - beforeX*scale; ty = cy - beforeY*scale; applyTransform();
    }

    async function setImage(i){
      if(i<0 || i>=items.length) return; index=i; empty.style.display='none';
      const it = items[i];
      await ensureBlob(it);
      img.src = it.blobUrl;
      [...thumbs.children].forEach((el,idx)=> el.classList.toggle('active', idx===i));
      // 等待尺寸
      await new Promise(r=>{ img.onload=r; });
      naturalW = img.naturalWidth; naturalH = img.naturalHeight; rotation=0; fitToStage();
    }

    function next(delta){ if(!items.length) return; const n=(index+delta+items.length)%items.length; setImage(n); }

    // Pointer 手势：拖拽/捏合
    let pointers=new Map();
    const pinchState={active:false,startDist:0,startScale:1};
    stage.addEventListener('pointerdown', e=>{ stage.setPointerCapture(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); lastTap.register(e); });
    stage.addEventListener('pointermove', e=>{
      if(!pointers.has(e.pointerId)) return;
      const prev=pointers.get(e.pointerId); const dx=e.clientX-prev.x; const dy=e.clientY-prev.y; pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      if(pointers.size===1){ tx+=dx; ty+=dy; applyTransform(); }
      else if(pointers.size===2){ const [a,b]=[...pointers.values()]; pinchUpdate(a,b); }
    });
    function pinchUpdate(a,b){
      const dist=Math.hypot(a.x-b.x,a.y-b.y);
      if(!pinchState.active){ pinchState.active=true; pinchState.startDist=dist; pinchState.startScale=scale; return; }
      const s = pinchState.startScale * (dist/Math.max(10,pinchState.startDist));
      setScaleAt(s, (a.x+b.x)/2, (a.y+b.y)/2);
    }
    function onUp(e){ pointers.delete(e.pointerId); if(pointers.size<2) pinchState.active=false; }
    stage.addEventListener('pointerup', onUp); stage.addEventListener('pointercancel', onUp);
    stage.addEventListener('wheel', e=>{ e.preventDefault(); const factor = e.deltaY<0?1.1:0.9; setScaleAt(scale*factor, e.clientX, e.clientY); }, {passive:false});

    // 双击切换缩放
    const lastTap={t:0,x:0,y:0, register(e){ const now=performance.now(); if(now-this.t<350 && Math.hypot(e.clientX-this.x,e.clientY-this.y)<20){ const target= scale<2 ? 2 : Math.min(8, scale*0.5); setScaleAt(target, e.clientX, e.clientY);} this.t=now; this.x=e.clientX; this.y=e.clientY; }}

    // 按钮与键盘
    btnFit.addEventListener('click', fitToStage); btnOne.addEventListener('click', ()=>setScaleAt(1, stage.clientWidth/2, stage.clientHeight/2));
    btnRotate.addEventListener('click', ()=>{ rotation=(rotation+90)%360; applyTransform(); });
    btnPrev.addEventListener('click', ()=>next(-1)); btnNext.addEventListener('click', ()=>next(1));
    window.addEventListener('keydown', e=>{ if(e.key==='ArrowRight') next(1); else if(e.key==='ArrowLeft') next(-1); });

    new ResizeObserver(()=>{ if(index>=0) fitToStage(); }).observe(stage);

    // 加载按钮
    btnLoad.addEventListener('click', ()=> loadFolder(urlInput.value));

    // 自动加载默认示例（可删掉）
    loadFolder(DEFAULT_LINK);

    // 兼容 Quest3：优化内存——切图时释放上一张 blob URL（如需回退带宽请注释）
    const revokeQueue=[]; const REVOKE_DELAY=8000;
    img.addEventListener('load', ()=>{
      // 清理较早的 URL，避免 Quest 浏览器内存压力
      while(revokeQueue.length>8){ const url=revokeQueue.shift(); URL.revokeObjectURL(url); }
      const current = items[index]?.blobUrl; if(current) revokeQueue.push(current);
      setTimeout(()=>{
        // 延迟回收，确保缩略图仍可用（这里只回收被替换很久的 URL）
      }, REVOKE_DELAY);
    });
  </script>
</body>
</html>
