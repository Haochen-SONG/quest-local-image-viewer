<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>本地图片浏览器 · 适配触控/手柄拖拽与捏合缩放</title>
  <style>
    :root{
      --bg:#0b0d10;--fg:#e9eef5;--muted:#9aa4b2;--accent:#5dd6ff;--card:#12161b;--border:#222a33;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%;}
    header{display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f1318,#0c0f13);}
    header h1{font-size:1rem;margin:0;color:var(--fg);opacity:.9}
    header .spacer{flex:1}
    button, label.btn{background:var(--card);border:1px solid var(--border);color:var(--fg);padding:.5rem .7rem;border-radius:.6rem;cursor:pointer;font-size:.95rem}
    button:hover,label.btn:hover{border-color:#2f3a46}
    input[type=file]{display:none}

    .content{display:grid;grid-template-columns:280px 1fr; min-height:0}
    .sidebar{border-right:1px solid var(--border);min-width:220px;max-width:420px;display:flex;flex-direction:column;min-height:0}
    .sidebar .bar{display:flex;gap:.5rem;padding:.5rem;border-bottom:1px solid var(--border)}
    .thumbs{overflow:auto;padding:.6rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.6rem}
    .thumb{position:relative;background:#0c1116;border:1px solid var(--border);border-radius:.5rem;aspect-ratio:1/1;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .name{position:absolute;left:.35rem;right:.35rem;bottom:.35rem;font-size:.7rem;color:var(--muted);text-shadow:0 1px 2px #000a;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .thumb.active{outline:2px solid var(--accent)}

    .viewer{position:relative;min-height:0}
    .stage{position:absolute;inset:0;background:#0a0c10;display:grid;place-items:center;overflow:hidden;touch-action:none}
    .img{max-width:none;max-height:none;user-select:none;-webkit-user-drag:none;transform-origin:0 0;will-change:transform}
    .overlay{position:absolute;left:0;right:0;bottom:0;display:flex;gap:.4rem;padding:.5rem;justify-content:center;pointer-events:none}
    .overlay .pill{pointer-events:auto;background:#0e1319bb;border:1px solid var(--border);backdrop-filter:blur(6px);padding:.35rem .55rem;border-radius:999px;display:flex;gap:.3rem;align-items:center}
    .overlay button{background:transparent;border:0;color:var(--fg);padding:.3rem .6rem;border-radius:.5rem}
    .overlay button:hover{background:#ffffff12}
    .hint{position:absolute;right:.6rem;top:.6rem;color:var(--muted);font-size:.8rem;background:#0e1319bb;border:1px solid var(--border);padding:.35rem .5rem;border-radius:.5rem}
    .empty{place-self:center;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0f1319;border:1px solid var(--border);padding:.05rem .35rem;border-radius:.35rem}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>本地图片浏览器</h1>
      <div class="spacer"></div>
      <label class="btn">
        选择图片/文件夹
        <input id="picker" type="file" accept="image/*" multiple webkitdirectory>
      </label>
      <button id="openFileSystem">目录授权(实验性)</button>
    </header>

    <div class="content">
      <aside class="sidebar">
        <div class="bar" style="justify-content:space-between">
          <small style="color:var(--muted)">缩略图</small>
          <small id="count" style="color:var(--muted)">0</small>
        </div>
        <div id="thumbs" class="thumbs" aria-label="thumbnails"></div>
      </aside>

      <main class="viewer">
        <div class="stage" id="stage">
          <div class="empty" id="empty">选择左侧的图片，或点击上方按钮载入。<br>支持拖拽/手势拖动、滚轮/捏合缩放、双击/双击手势切换缩放。</div>
          <img id="img" class="img" alt="" />
          <div class="overlay">
            <div class="pill">
              <button id="fit">适应</button>
              <button id="one">100%</button>
              <button id="rotate">旋转90°</button>
              <button id="prev">上一张 ←</button>
              <button id="next">下一张 →</button>
            </div>
          </div>
          <div class="hint">拖拽=平移 · 捏合/滚轮=缩放 · 双击=切换缩放 · 方向键翻图</div>
        </div>
      </main>
    </div>
  </div>

<script>
(()=>{
  const picker = document.getElementById('picker');
  const thumbs = document.getElementById('thumbs');
  const countEl = document.getElementById('count');
  const img = document.getElementById('img');
  const stage = document.getElementById('stage');
  const btnFit = document.getElementById('fit');
  const btnOne = document.getElementById('one');
  const btnRotate = document.getElementById('rotate');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const empty = document.getElementById('empty');
  const openFS = document.getElementById('openFileSystem');

  // === 兼容/防崩溃处理 ===
  const ua = navigator.userAgent || '';
  const isQuest = /OculusBrowser|Meta\s?Quest|Quest\s?\d/i.test(ua);
  const canDirPicker = !!window.showDirectoryPicker;

  // 在 Quest 或不支持的环境里隐藏“目录授权”按钮，避免崩溃
  if (!canDirPicker || isQuest) {
    openFS.style.display = 'none';
  }

  /** 图片列表与当前索引 **/
  let files = []; // {name, url, file}
  let index = -1;

  /** 视图状态（平移+缩放+旋转） **/
  let tx=0, ty=0, scale=1, rotation=0;
  let naturalW=0, naturalH=0; // 原始尺寸

  function resetTransform(){ tx=0; ty=0; scale=1; applyTransform(); }
  function applyTransform(){ img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale}) rotate(${rotation}deg)`; }

  function setImage(i){
    if(i<0||i>=files.length) return; index=i;
    const f = files[i];
    img.src = f.url; img.alt = f.name;
    [...thumbs.children].forEach((el,idx)=>{
      el.classList.toggle('active', idx===i);
    });
    img.onload = ()=>{
      naturalW = img.naturalWidth; naturalH = img.naturalHeight; fitToStage();
    };
    empty.style.display='none';
  }

  function fitToStage(){
    const rect = stage.getBoundingClientRect();
    const imgW = naturalW, imgH = naturalH;
    if(!imgW || !imgH) return;
    const s = Math.min((rect.width*0.98)/imgW, (rect.height*0.98)/imgH);
    scale = Math.max(0.05, Math.min(8, s));
    tx = (rect.width - imgW*scale)/2;
    ty = (rect.height - imgH*scale)/2;
    applyTransform();
  }

  function setScaleAt(newScale, cx, cy){
    newScale = Math.max(0.05, Math.min(16, newScale));
    const beforeX = (cx - tx)/scale;
    const beforeY = (cy - ty)/scale;
    scale = newScale;
    tx = cx - beforeX*scale;
    ty = cy - beforeY*scale;
    applyTransform();
  }

  function next(delta){
    if(!files.length) return;
    const n = (index + delta + files.length) % files.length;
    setImage(n);
  }

  // 载入文件列表
  picker.addEventListener('change', async (e)=>{
    const list = Array.from(e.target.files).filter(f=>f.type.startsWith('image/'));
    if(!list.length) return;
    files.forEach(f=>URL.revokeObjectURL(f.url));
    files = list.map(f=>({name:f.webkitRelativePath||f.name, url:URL.createObjectURL(f), file:f}));
    renderThumbs(); setImage(0);
  });

  // （桌面浏览器可用）File System Access API 目录选择
  openFS.addEventListener('click', async ()=>{
    if(!canDirPicker){ alert('当前浏览器不支持目录授权。'); return; }
    try{
      const dir = await window.showDirectoryPicker();
      const imgs = [];
      for await (const [name, handle] of dir.entries()){
        if(handle.kind==='file'){
          const ext = name.split('.').pop().toLowerCase();
          if(['jpg','jpeg','png','gif','webp','bmp','avif','heic','heif','svg'].includes(ext)){
            const file = await handle.getFile();
            imgs.push({name, url:URL.createObjectURL(file), file});
          }
        }
      }
      if(!imgs.length){ alert('该目录内未发现图片文件'); return; }
      files.forEach(f=>URL.revokeObjectURL(f.url));
      files = imgs.sort((a,b)=>a.name.localeCompare(b.name));
      renderThumbs(); setImage(0);
    }catch(err){
      if(err && err.name!=='AbortError') alert('目录授权失败：'+err.message);
    }
  });

  function renderThumbs(){
    thumbs.innerHTML='';
    files.forEach((f,i)=>{
      const div=document.createElement('button');
      div.className='thumb';
      div.title=f.name;
      div.addEventListener('click',()=>setImage(i));
      const im=document.createElement('img'); im.src=f.url; im.loading='lazy';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=f.name.split('/').pop();
      div.appendChild(im); div.appendChild(nm); thumbs.appendChild(div);
    });
    countEl.textContent=String(files.length);
  }

  // 平移/缩放（Pointer Events）
  let pointers=new Map();
  let pinchState={active:false,startDist:0,startScale:1};

  function onPointerDown(e){
    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    lastTap.register(e);
  }
  function onPointerMove(e){
    if(!pointers.has(e.pointerId)) return;
    const prev = pointers.get(e.pointerId);
    const dx = e.clientX - prev.x; const dy = e.clientY - prev.y;
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(pointers.size===1){
      tx += dx; ty += dy; applyTransform();
    } else if(pointers.size===2){
      const pts=[...pointers.values()];
      const a=pts[0], b=pts[1];
      pinchUpdate(a,b);
    }
  }
  function onPointerUp(e){
    pointers.delete(e.pointerId);
    if(pointers.size<2) pinchState.active=false;
  }

  function pinchUpdate(a,b){
    const cx=(a.x+b.x)/2, cy=(a.y+b.y)/2;
    if(!pinchState.active){
      pinchState.active=true;
      pinchState.startDist=Math.hypot(a.x-b.x,a.y-b.y);
      pinchState.startScale=scale;
      return;
    }
    const dist=Math.hypot(a.x-b.x,a.y-b.y);
    const s = pinchState.startScale * (dist / Math.max(10,pinchState.startDist));
    setScaleAt(s, cx, cy);
  }

  stage.addEventListener('pointerdown', onPointerDown);
  stage.addEventListener('pointermove', onPointerMove);
  stage.addEventListener('pointerup', onPointerUp);
  stage.addEventListener('pointercancel', onPointerUp);

  // 滚轮缩放（PC 兼容）
  stage.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const factor = e.deltaY<0 ? 1.1 : 0.9;
    setScaleAt(scale*factor, e.clientX, e.clientY);
  }, {passive:false});

  // 双击/双击手势：在适应与200%之间切换
  const lastTap={t:0,x:0,y:0, register(e){
    const now=performance.now();
    if(now-this.t<350 && Math.hypot(e.clientX-this.x, e.clientY-this.y)<20){
      const targetScale = scale<2 ? 2 : Math.min(8, scale*0.5);
      setScaleAt(targetScale, e.clientX, e.clientY);
    }
    this.t=now; this.x=e.clientX; this.y=e.clientY;
  }}

  // 按钮与键盘
  btnFit.addEventListener('click', fitToStage);
  btnOne.addEventListener('click', ()=>{ setScaleAt(1, stage.clientWidth/2, stage.clientHeight/2); });
  btnRotate.addEventListener('click', ()=>{ rotation=(rotation+90)%360; applyTransform(); });
  btnPrev.addEventListener('click', ()=>next(-1));
  btnNext.addEventListener('click', ()=>next(1));
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') next(1);
    else if(e.key==='ArrowLeft') next(-1);
    else if(e.key==='f') fitToStage();
    else if(e.key==='1') btnOne.click();
  });

  // 自适应
  new ResizeObserver(()=>{ if(index>=0) fitToStage(); }).observe(stage);

  // 拖放导入（桌面浏览器）
  stage.addEventListener('dragover', e=>{e.preventDefault();});
  stage.addEventListener('drop', e=>{
    e.preventDefault();
    const list = Array.from(e.dataTransfer.files||[]).filter(f=>f.type.startsWith('image/'));
    if(!list.length) return;
    files.forEach(f=>URL.revokeObjectURL(f.url));
    files = list.map(f=>({name:f.name, url:URL.createObjectURL(f), file:f}));
    renderThumbs(); setImage(0);
  });
})();
</script>
</body>
</html>
